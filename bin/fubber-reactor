#!/usr/bin/php
<?php
/**
*	This is the script that starts up the Fubber Reactor server and monitors that it has not crashed.
*/

// Find the config file
$cwd = getcwd();
while($cwd != "/" && is_dir($cwd) && !file_exists($cwd.'/fubber-reactor.json'))
	$cwd = dirname($cwd);

if(!file_exists($cwd.'/fubber-reactor.json'))
	$fubberReactorConfig = new stdClass();
else
	$fubberReactorConfig = json_decode(file_get_contents($cwd.'/fubber-reactor.json'));

if(!is_object($fubberReactorConfig))
	die("Config file must contain a valid json structure.\n");

if(isset($fubberReactorConfig->init)) {
	require($fubberReactorConfig->init);
} else {
	if(file_exists('vendor/autoload.php'))
		require('vendor/autoload.php');
	else
		die("Unable to find vendor/autoload.php. Either start Fubber Reactor from a folder containing vendor/autoload.php or define the path in \$config->init\n");
}

echo "Fubber Reactor Starting: ";
if(has_inotify()) {
	$inotifyPid = spawn_inotify();
	echo "[file monitor]";
}
$serverPid = spawn_server();
echo "[server]\n";

while(TRUE) {
	usleep(100000);
	$result = pcntl_waitpid($serverPid, $status, WNOHANG);
	if($result == -1 || $result > 0) {
		echo "Restarting server (PID=$result)\n";
		$serverPid = spawn_server();
	}
	if(has_inotify()) {
		$result = pcntl_waitpid($inotifyPid, $status, WNOHANG);
		if($result == -1 || $result > 0) {
			echo "Restarting directory watch (PID=$result)\n";
			$inotifyPid = spawn_inotify();
			echo "Killing server (PID=$serverPid)\n";
			posix_kill($serverPid, SIGABRT);
		}
	}
}

function has_inotify() {
	static $result = NULL;
	if($result === NULL)
		$result = file_exists('/usr/bin/inotifywait');
	return $result;
}

function spawn_inotify() {
	$inotifyPid = pcntl_fork();
	if(!$inotifyPid) {
		// Start inotify
		shell_exec("/usr/bin/inotifywait -qq -r -e 'modify,move,create,delete' ./");
		die();
	}
	return $inotifyPid;
}

function spawn_server() {
	global $fubberReactorConfig;
	$serverPid = pcntl_fork();
	if(!$serverPid) {
		new \Fubber\Reactor\Host($fubberReactorConfig);
		die();
	}

	return $serverPid;
}
